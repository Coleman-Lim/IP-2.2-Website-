<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/navbar-fixed/">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"
        defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">
    <link rel="icon" href="images/Asset 1.png">

    <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="navbar.css" rel="stylesheet">
    <link href="footer.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">


</head>

<style>
    @font-face {
        font-family: 'sewalik';
        src: url('Font/sewalik') format('truetype');
    }

    @font-face {
        font-family: 'sewalikBold';
        src: url('Font/sewalikBold') format('truetype');
    }

    @font-face {
        font-family: 'sewalikSemiBold';
        src: url('Font/sewalikSemiBold') format('truetype');
    }

    body {
        font-family: url('Font/sewalik');
        font-size: 20px;
    }

    h1 {
        font-family: url('Font/sewalikBold');
    }

    h2 {
        font-family: url('Font/sewalikSemiBold');
        margin-bottom: 20px;
    }

    body {
        margin: 0;
        padding: 0;
        background-image: url('images/Background1.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;

    }

    .gradient-bg {
        background: white !important;
        padding: 2rem;
        border-radius: 0.5rem;
    }

    .album {
        background-color: transparent !important;
    }

    #myBtn1 {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 30px;
        z-index: 99;
        font-size: 18px;
        border: none;
        outline: none;
        background-color: blue;
        color: white;
        cursor: pointer;
        padding: 20px;
        border-radius: 4px;
    }

    #myBtn1:hover {
        background-color: #555;
    }

    .modal {
        display: none;
        /* Hidden by default */
        position: fixed;
        /* Stay in place */
        z-index: 1;
        /* Sit on top */
        padding-top: 100px;
        /* Location of the modal */
        left: 0;
        top: 0;
        width: 100%;
        /* Full width */
        height: 100%;
        /* Full height */
        overflow: auto;
        /* Enable scroll if needed */
        background-color: rgb(0, 0, 0);
        /* Fallback color */
        background-color: rgba(0, 0, 0, 0.9);
        /* Black w/ opacity */
    }

    .modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
    }



    .close:hover,
    .close:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }

    .modal-description {
        text-align: center;
        color: #fff;
        font-size: 16px;
        padding-top: 10px;
    }
</style>

<body>
    <button onclick="topFunction()" id="myBtn1" title="Go to top">
        <i class="fas fa-chevron-up"></i> </button>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="images/logo-image 2.png" alt="Logo" height="50">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#"></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" aria-disabled="true"></a>
                    </li>
                </ul>
                <form class="d-flex" role="search">
                    <button class="btn btn-outline-success" type="button" style="border: none;"
                        onclick="window.location.href = 'gameoverview.html'">
                        <img src="images/house.jpg" alt="Back" style="width: 50px; height: 50px; border-radius: 50%;">
                    </button>

                </form>
            </div>
        </div>
    </nav>
    <main>
        <div class="container my-4">
            <h1 class="WelcomeText">User Profile</h1>
        </div>

        <!-- First Container -->
        <div class="container light-style flex-grow-1 container-p-y">

            <div class="card overflow-hidden">
                <div class="row no-gutters row-bordered row-border-light">
                    <div class="col-md-3 pt-0">
                        <div class="list-group list-group-flush account-settings-links">
                            <a class="list-group-item list-group-item-action active" data-toggle="list"
                                href="#account-general">General</a>
                            <a class="list-group-item list-group-item-action" data-toggle="list"
                                href="#account-change-password">Change password</a>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="tab-content">
                            <div class="tab-pane fade active show" id="account-general">
                                <div class="card-body media align-items-center">
                                    <img src="images/blank image icon.jpg" alt="User Avatar" class="d-block ui-w-80"
                                        id="avatar-preview">
                                    <div class="media-body ml-4 d-flex align-items-center">
                                        <button class="btn btn-outline-primary" id="upload-button">Upload new
                                            photo</button>
                                        <input type="file" class="user-file" accept="image/jpeg, image/png, image/jpg"
                                            id="file-path" hidden>
                                        &nbsp;
                                        <button type="button" class="btn btn-default md-btn-flat"
                                            id="reset-btn">Reset</button>
                                        <div class="text-light small mt-1">Allowed JPG, GIF or PNG. Max size of 800K
                                        </div>


                                        <a href="index.html" class="btn btn-outline-success ms-auto" role="button">Log
                                            Out</a>
                                    </div>

                                </div>
                                <form id="changeUserDetails">
                                    <hr class="border-light m-0">
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label class="form-label">Username</label>
                                            <input type="text" id="inputUsername" class="form-control mb-1" value="">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Gender</label>
                                            <input type="text" id="inputGender" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Age</label>
                                            <input type="text" id="inputRace" class="form-control">
                                        </div>
                                        <div class="text-right mt-3">
                                            <button type="submit" class="btn btn-primary">Save changes</button>
                                        </div>
                                    </div>
                                </form>
                            </div>


                            <div class="tab-pane fade" id="account-change-password">
                                <form id="changePassword">
                                    <div class="card-body pb-2">
                                        <div class="form-group">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" class="form-control" id="inputPassword">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="inputNewPassword">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" id="inputConfirmNewPassword">
                                        </div>
                                        <div class="text-right mt-3">
                                            <button type="submit" class="btn btn-primary">Save changes</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        </div>
        <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
        <script type="text/javascript">

        </script>



        <!-- Second Container -->
        <div id="imageModal" class="modal" onclick="closeModal(event)">
            <img id="modalImage" class="modal-content" alt="Image">
            <div id="modalDescription" class="modal-description"></div>
        </div>

        <div class="album py-5 bg-body-tertiary">
            <div class="container">

                <div class="d-flex align-items-center mb-3">
                    <h1 class="GalleryText me-3">Gallery</h1>
                    <button id="refreshButton" class="btn btn-primary">Refresh</button>
                </div>
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3" id="gallery"></div>
            </div>
        </div>



        <div class="container my-4">
            <footer class="py-5">
                <div class="row">
                    <div class="col-6 col-md-2 mb-3">
                        <h5>Section</h5>
                        <ul class="nav flex-column">
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Home</a></li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Features</a>
                            </li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Pricing</a>
                            </li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">FAQs</a></li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">About</a>
                            </li>
                        </ul>
                    </div>

                    <div class="col-6 col-md-2 mb-3">
                        <h5>Section</h5>
                        <ul class="nav flex-column">
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Home</a></li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Features</a>
                            </li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Pricing</a>
                            </li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">FAQs</a></li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">About</a>
                            </li>
                        </ul>
                    </div>

                    <div class="col-6 col-md-2 mb-3">
                        <h5>Section</h5>
                        <ul class="nav flex-column">
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Home</a></li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Features</a>
                            </li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Pricing</a>
                            </li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">FAQs</a></li>
                            <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">About</a>
                            </li>
                        </ul>
                    </div>

                    <div class="col-md-5 offset-md-1 mb-3">
                        <form>
                            <h5>Subscribe to our newsletter</h5>
                            <p>Monthly digest of what's new and exciting from us.</p>
                            <div class="d-flex align-items-center gap-2 w-100"> <label for="newsletter1"
                                    class="visually-hidden">Email address</label>
                                <input id="newsletter1" type="text" class="form-control" placeholder="Email address">
                                <button class="btn btn-primary" type="button">Subscribe</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="d-flex flex-column flex-sm-row justify-content-between py-4 my-4 border-top">
                    <p>&copy; 2024 HoloHands, Inc. All rights reserved.</p>
                    <ul class="list-unstyled d-flex">
                        <li class="ms-3"><a class="link-body-emphasis" href="#"><svg class="bi" width="24" height="24">
                                    <use xlink:href="#twitter" />
                                </svg></a></li>
                        <li class="ms-3"><a class="link-body-emphasis" href="#"><svg class="bi" width="24" height="24">
                                    <use xlink:href="#instagram" />
                                </svg></a></li>
                        <li class="ms-3"><a class="link-body-emphasis" href="#"><svg class="bi" width="24" height="24">
                                    <use xlink:href="#facebook" />
                                </svg></a></li>
                    </ul>
                </div>
            </footer>
        </div>

    </main>
</body>
<script>
    let mybutton = document.getElementById("myBtn1");


    window.onscroll = function () { scrollFunction() };

    function scrollFunction() {
        if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
            mybutton.style.display = "block";
        } else {
            mybutton.style.display = "none";
        }
    }


    function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    }


</script>

<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
    import { getDatabase, ref, get, query, orderByChild, equalTo, set, update, remove } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAXUldvOSdXM2ySevIf_Dt9WRkO_YPK-A0",
        authDomain: "ip-holohands.firebaseapp.com",
        databaseURL: "https://ip-holohands-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ip-holohands",
        storageBucket: "ip-holohands.firebasestorage.app",
        messagingSenderId: "470348418514",
        appId: "1:470348418514:web:c7c1e2fef3a74567088c0b",
        measurementId: "G-TMVDP0CP36"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();


    const supabaseURL = 'https://mrjzpnoiqdnifempamof.supabase.co/'
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yanpwbm9pcWRuaWZlbXBhbW9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5NDYxMzEsImV4cCI6MjA1MzUyMjEzMX0.39LpnJhxYgOT6CbHPzj6tfbimiwmjmEiz6MfkUVWpPE"

    document.getElementById("changeUserDetails").addEventListener("submit", (e) => {
        e.preventDefault();
        const newUsername = document.getElementById("inputUsername").value.trim();
        const newGender = document.getElementById("inputGender").value.trim();
        const newRace = document.getElementById("inputRace").value.trim();


        const user = auth.currentUser;
        const updates = {};
        let updateCount = 0;

        if (newUsername) {
            updates["username"] = newUsername;
            updateCount++;
        }

        if (newGender) {
            updates["gender"] = newGender;
            updateCount++;
        }
        if (newRace) {
            updates["age"] = newRace;
            updateCount++;
        }

        if (updateCount === 0) {
            alert("No changes were made.");
            return;
        }

        // Update Firebase once with all changes
        update(ref(db, "players/" + user.uid), updates)
            .then(() => {
                if (updateCount > 1) {
                    alert("All user details updated successfully!");
                } else {
                    alert("User detail updated successfully!");
                }
                document.getElementById("changeUserDetails").reset(); // Clear form
            })
            .catch((error) => {
                console.error("Error updating user data:", error);
            });


        window.updateUserData = updateUserData;
    })

    document.getElementById('upload-button').addEventListener('click', function () {
        document.getElementById('file-path').click();
    });

    document.getElementById('file-path').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const imageData = e.target.result;


                document.getElementById('avatar-preview').src = imageData;


                // Save image in localStorage
                localStorage.setItem('uploadedImage', imageData);
            };
            reader.readAsDataURL(file);
        } else {
            alert('Please select a valid image file.');
        }
    });


    window.addEventListener('load', function () {
        const savedImage = localStorage.getItem('uploadedImage');
        if (savedImage) {
            document.getElementById('avatar-preview').src = savedImage;
        }
    });



    document.getElementById('reset-btn').addEventListener('click', function () {
        document.getElementById('avatar-preview').src = "images/blank image icon.jpg";
        document.getElementById('file-path').value = "";
    });




    function loadScreenshots(uid) {
        const gallery = document.querySelector(".row.g-3");
        gallery.innerHTML = "";

        const userRef = ref(db, `screenshots/${uid}`);
        get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
                console.log(snapshot);
                try {
                    const ssArray = [];

                    snapshot.forEach((child) => {
                        const screenshot = child.val();
                        console.log(screenshot.URL);
                        ssArray.push({ URL: screenshot.URL, description: screenshot.description || "No description available" });
                    });

                    const ssArrayReverse = ssArray.reverse();
                    console.log(ssArrayReverse);


                    for (let i = 0; i < ssArrayReverse.length; i++) {
                        const screenshotData = ssArrayReverse[i];
                        const cardHTML = `
                        <div class="col" id="card-${i}">
                            <div class="card shadow-sm">
                                <img src="${screenshotData.URL}" alt="Screenshot" class="card-img-top" id="image-${i}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group flex-column w-100">
                                            <button type="button" class="btn btn-sm mb-2 w-100 btn-outline-secondary" id="view-btn-${i}">View</button>
                                            <button type="button" class="btn btn-sm btn-danger w-100" id="delete-btn-${i}">Delete</button> 
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                        gallery.insertAdjacentHTML("beforeend", cardHTML);


                        const viewButton = document.getElementById(`view-btn-${i}`);
                        const deleteButton = document.getElementById(`delete-btn-${i}`);
                        const image = document.getElementById(`image-${i}`);


                        viewButton.addEventListener("click", () => {
                            console.log(`View button clicked for image ${i}`);
                            openModal(screenshotData.URL);
                        });


                        deleteButton.addEventListener("click", () => {
                            const cardToDelete = document.getElementById(`card-${i}`);

                            if (cardToDelete) {
                                get(userRef).then((snapshot) => {
                                    if (snapshot.exists()) {
                                        let index = 0;
                                        snapshot.forEach((child) => {
                                            if (index === i) {
                                                const screenshotKey = child.key; // Get the Firebase key
                                                console.log(`Deleting screenshot with key: ${screenshotKey}`);

                                                // Delete from Firebase Database
                                                const screenshotRef = ref(db, `screenshots/${uid}/${screenshotKey}`);
                                                remove(screenshotRef)
                                                    .then(() => {
                                                        console.log(`Screenshot ${i} deleted from Firebase`);

                                                        // Remove from UI
                                                        cardToDelete.remove();
                                                        console.log(`Card ${i} deleted`);
                                                    })
                                                    .catch((error) => {
                                                        console.error("Error deleting screenshot:", error);
                                                    });
                                            }
                                            index++;
                                        });
                                    }
                                }).catch((error) => {
                                    console.error("Error fetching data for deletion:", error);
                                });
                            }
                        });

                    }
                } catch (error) {
                    console.log("Error processing data", error);
                }
            } else {
                gallery.innerHTML = "<p style='font-size: 24px; color: #888; text-align: left; padding-top: 10px;'>No images available.</p>";
            }
        }).catch((error) => {
            console.log("Error fetching data", error);
        });
    }


    function openModal(imageURL) {
        const modal = document.getElementById("imageModal");
        const modalImage = document.getElementById("modalImage");
        const modalDescription = document.getElementById("modalDescription");

        modal.style.display = "block";
        modalImage.src = imageURL;
        modalDescription.textContent = "Click outside to close";
    }


    function closeModal(event) {
        event.stopPropagation();
        const modal = document.getElementById("imageModal");
        modal.style.display = "none";
    }


    window.onclick = function (event) {
        const modal = document.getElementById("imageModal");
        if (event.target === modal) {
            closeModal(event);
        }
    };

    let uid = null; // Declare uid globally

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Authenticated user:", user);
            uid = user.uid; // Store uid globally
            loadScreenshots(uid);
        } else {
            console.log("No user logged in");
            uid = null; // Reset uid when user logs out
        }
    });

    // Refresh Button Event Listener
    document.getElementById("refreshButton").addEventListener("click", () => {
        if (uid) {
            loadScreenshots(uid);
        } else {
            console.error("UID not available, user might not be logged in.");
        }
    });

    // Auto-refresh every 5 seconds
    setInterval(() => {
        if (uid) {
            loadScreenshots(uid);
        }
    }, 5000);






    // Initialize Firebase

    // Handle form submission
    document.getElementById("changePassword").addEventListener("submit", async (event) => {
        event.preventDefault();

        const currentPassword = document.getElementById("inputPassword").value;
        const newPassword = document.getElementById("inputNewPassword").value;
        const confirmPassword = document.getElementById("inputConfirmNewPassword").value;

        if (newPassword !== confirmPassword) {
            alert("New password and confirmation do not match.");
            return;
        }

        const user = auth.currentUser;

        if (!user) {
            alert("No user is logged in.");
            return;
        }

        try {

            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);


            await updatePassword(user, newPassword);
            alert("Password changed successfully!");


            auth.signOut().then(() => {
                alert("Password updated. Please log in again.");
                window.location.href = "sign in.html";
            });

        } catch (error) {
            console.error("Error changing password:", error);
            alert(error.message);
        }
    });
</script>